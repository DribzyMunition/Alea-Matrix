<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alea Matrix — Ratios</title>
  <style>
    :root{
      --bg:#030d03; --grid:#0f2d0f; --panel:#081808; --text:#b6ffb6; --muted:#76c876; --accent:#00ff88; --danger:#ff5577; --ok:#44ff99;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text); padding:24px}
    body::before{content:""; position:fixed; inset:0; background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px); background-size:24px 24px, 24px 24px; opacity:.22; pointer-events:none}
    .wrap{max-width:1100px; margin:0 auto}
    h1{margin:0 0 8px}
    .sub{color:var(--muted); margin-bottom:18px}
    .grid{display:grid; gap:16px; grid-template-columns:1.15fr 1fr}
    .card{background:linear-gradient(180deg, rgba(8,24,8,.9), rgba(8,24,8,.65)); border:1px solid #0b2a0b; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{width:100%; border:1px solid #0b2a0b; border-radius:12px; background:#051105; color:var(--text); padding:10px; outline:none}
    textarea{min-height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .row{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    .btns{display:flex; gap:10px; margin-top:10px}
    button{cursor:pointer; border:1px solid #0b2a0b; background:#041004; color:var(--text); padding:10px 12px; border-radius:12px; font-weight:600}
    button.primary{border-color:var(--accent); box-shadow:0 0 0 1px rgba(0,255,136,.2) inset}
    .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .kpi{background:#051405; border:1px solid #0b2a0b; border-radius:14px; padding:14px}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:22px; font-weight:700; margin-top:6px}
    canvas{width:100%; height:240px; display:block; border-radius:12px; background:#041204; border:1px solid #0b2a0b}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 6px; border-bottom:1px dashed #0b2a0b; text-align:left}
    .muted{color:var(--muted)}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .row{grid-template-columns:1fr} .kpis{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Alea Matrix — Risk-Adjusted Ratios</h1>
    <div class="sub">Compute <b>Sharpe</b> and <b>Sortino</b> (aka risk/return ratios), plus CAGR, Stdev, Downside Dev, and Max Drawdown. Paste returns or upload CSV. Nothing here is advice.</div>

    <div class="grid">
      <section class="card">
        <div class="row">
          <div>
            <label>Periodic Returns Input</label>
            <textarea id="returns" placeholder="One return per line, e.g.\n0.004\n-0.012\n0.006\n...">0.004\n-0.012\n0.006\n0.010\n-0.007\n0.003\n</textarea>
          </div>
          <div>
            <label>Upload CSV (optional)</label>
            <input id="file" type="file" accept=".csv,text/csv" />
            <div style="height:12px"></div>
            <label>Periodicity</label>
            <select id="period">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
            <div style="height:12px"></div>
            <label>Risk-free Rate (annual, %)</label>
            <input id="rf" type="number" inputmode="decimal" value="0.0" />
            <div style="height:12px"></div>
            <label>Target/ MAR for Sortino (annual, %)</label>
            <input id="mar" type="number" inputmode="decimal" value="0.0" />
          </div>
        </div>
        <div class="btns">
          <button class="primary" id="calc">Calculate Ratios</button>
          <button id="clear">Clear</button>
          <button id="demo">Demo Data</button>
        </div>
        <div class="muted" style="margin-top:8px">CSV accepted formats: either a single column of returns (fractional, e.g., 0.012) or two columns <code>date,return</code>. Dates improve CAGR accuracy.</div>
      </section>

      <section class="card">
        <div class="kpis">
          <div class="kpi"><div class="label">Sharpe (ann.)</div><div class="value" id="sharpe">—</div></div>
          <div class="kpi"><div class="label">Sortino (ann.)</div><div class="value" id="sortino">—</div></div>
          <div class="kpi"><div class="label">CAGR</div><div class="value" id="cagr">—</div></div>
        </div>
        <div class="kpis" style="margin-top:12px">
          <div class="kpi"><div class="label">Stdev (ann.)</div><div class="value" id="stdev">—</div></div>
          <div class="kpi"><div class="label">Downside Dev (ann.)</div><div class="value" id="downside">—</div></div>
          <div class="kpi"><div class="label">Max Drawdown</div><div class="value" id="mdd">—</div></div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <canvas id="chart"></canvas>
      <div class="muted" style="margin-top:8px">Chart: cumulative equity curve from provided returns (rebased to 1.0). Hover for values.</div>
    </section>

    <section class="card" style="margin-top:16px">
      <table>
        <thead><tr><th>Metric</th><th>Definition</th><th>Formula</th></tr></thead>
        <tbody>
          <tr><td>Sharpe</td><td>Excess return per unit of volatility</td><td>(Mean[r - rf_p] / Stdev[r]) × √annualizer</td></tr>
          <tr><td>Sortino</td><td>Excess return per unit of downside volatility</td><td>(Mean[r - mar_p] / DownsideDev[r]) × √annualizer</td></tr>
          <tr><td>CAGR</td><td>Compound annual growth rate</td><td>((Π(1+r))^{year_frac} − 1)</td></tr>
          <tr><td>Max Drawdown</td><td>Largest drop from peak in equity curve</td><td>min( equity/rolling_max − 1 )</td></tr>
        </tbody>
      </table>
    </section>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const fmt = (n, d=2, pct=false) => (isFinite(n)? (pct? (n*100).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d})+'%' : Number(n).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d})) : '—');

    const ANNUALS = { daily: 252, weekly: 52, monthly: 12 };

    function parseText(txt){
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const vals = [];
      for(const line of lines){
        const parts = line.split(/,|;|\s+/).map(s=>s.trim()).filter(Boolean);
        const v = parseFloat(parts[parts.length-1]);
        if(!isNaN(v)) vals.push(v);
      }
      return vals;
    }

    function parseCSV(file){
      return new Promise((resolve)=>{
        const reader = new FileReader();
        reader.onload = () => {
          const text = reader.result.toString();
          const lines = text.split(/\r?\n/).filter(Boolean);
          const vals = []; let firstDate=null,lastDate=null;
          for(const line of lines){
            const cols = line.split(/,|;|\t/).map(x=>x.trim());
            if(cols.length===1){
              const v = parseFloat(cols[0]); if(!isNaN(v)) vals.push(v);
            } else {
              const maybeDate = new Date(cols[0]);
              const v = parseFloat(cols[1]);
              if(!isNaN(maybeDate.valueOf()) && !isNaN(v)){
                if(!firstDate) firstDate = maybeDate; lastDate = maybeDate; vals.push(v);
              } else { const num = parseFloat(cols[cols.length-1]); if(!isNaN(num)) vals.push(num); }
            }
          }
          resolve({vals, firstDate, lastDate});
        };
        reader.readAsText(file);
      });
    }

    function mean(a){ return a.reduce((s,x)=>s+x,0)/a.length; }
    function stdev(a){ const m=mean(a); return Math.sqrt(a.reduce((s,x)=>s+(x-m)*(x-m),0)/(a.length-1)); }
    function downsideDev(a, mar){ // downside deviation relative to MAR per period
      const diff = a.map(x=>Math.min(0, x - mar));
      const m = mean(diff);
      return Math.sqrt(diff.reduce((s,x)=>s+(x-m)*(x-m),0)/(diff.length-1));
    }
    function equity(vals){ const e=[1]; for(const r of vals){ e.push(e[e.length-1]*(1+r)); } return e; }
    function maxDrawdown(eq){ let peak=eq[0], mdd=0; for(const v of eq){ peak = Math.max(peak, v); mdd = Math.min(mdd, v/peak - 1); } return mdd; }

    function calc(){
      const period = $("period").value; const k = ANNUALS[period]||252;
      let vals = parseText($("returns").value);
      const rf_annual = parseFloat($("rf").value||0)/100;
      const mar_annual = parseFloat($("mar").value||0)/100;
      if(vals.length<2){ alert('Please provide at least 2 return values'); return; }

      // Convert annual rf/MAR to per-period
      const rf_p = Math.pow(1+rf_annual, 1/k) - 1;
      const mar_p = Math.pow(1+mar_annual, 1/k) - 1;

      const m = mean(vals);
      const sd = stdev(vals);
      const ddv = downsideDev(vals, mar_p);

      const sharpe = (m - rf_p) / (sd || 1e-12) * Math.sqrt(k);
      const sortino = (m - mar_p) / (ddv || 1e-12) * Math.sqrt(k);

      const eq = equity(vals);
      const mdd = maxDrawdown(eq);

      // CAGR: if we don't have dates, infer number of years by count/k
      const total = eq[eq.length-1];
      const years = vals.length / k;
      const cagr = Math.pow(total, 1/Math.max(1e-9, years)) - 1;

      $("sharpe").textContent = fmt(sharpe,2);
      $("sortino").textContent = fmt(sortino,2);
      $("stdev").textContent = fmt(sd*Math.sqrt(k),2);
      $("downside").textContent = fmt(ddv*Math.sqrt(k),2);
      $("mdd").textContent = fmt(mdd,2,true);
      $("cagr").textContent = fmt(cagr,2,true);

      drawChart(eq);
    }

    function clearAll(){ $("returns").value=''; $("rf").value='0.0'; $("mar").value='0.0'; $("sharpe").textContent=$("sortino").textContent=$("stdev").textContent=$("downside").textContent=$("mdd").textContent=$("cagr").textContent='—'; drawChart([1]); }

    function demo(){ $("returns").value = [0.004,-0.012,0.006,0.010,-0.007,0.003,0.008,0.005,-0.009,0.012,0.004,-0.004,0.007,0.002,-0.006,0.009].join("\n"); }

    async function onFile(e){ const f=e.target.files?.[0]; if(!f) return; const {vals}=await parseCSV(f); if(vals?.length){ $("returns").value = vals.join('\n'); } }

    function drawChart(eq){ const c=$("chart"); const ctx=c.getContext('2d'); const w=c.width=c.clientWidth; const h=c.height=c.clientHeight; ctx.clearRect(0,0,w,h);
      const min=Math.min(...eq), max=Math.max(...eq);
      const pad=16; const xstep=(w-2*pad)/Math.max(1,eq.length-1);
      function y(v){ return h-pad - ( (v-min)/(max-min||1) )*(h-2*pad); }
      // grid
      ctx.strokeStyle='rgba(0,255,120,0.2)'; ctx.lineWidth=1; ctx.beginPath(); for(let i=pad;i<w-pad;i+=Math.max(40,Math.floor(w/12))){ ctx.moveTo(i,pad); ctx.lineTo(i,h-pad);} for(let j=pad;j<h-pad;j+=40){ ctx.moveTo(pad,j); ctx.lineTo(w-pad,j);} ctx.stroke();
      // line
      ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle='rgba(0,255,136,0.8)';
      eq.forEach((v,i)=>{ const X=pad+i*xstep, Y=y(v); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); });
      ctx.stroke();
    }

    $("calc").addEventListener('click', calc);
    $("clear").addEventListener('click', clearAll);
    $("demo").addEventListener('click', demo);
    $("file").addEventListener('change', onFile);

    // Initial draw
    drawChart([1]);
  </script>
</body>
</html>
