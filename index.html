<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alea Matrix — Single Page</title>
  <style>
    :root{ --bg:#030d03; --grid:#0f2d0f; --panel:#081808; --text:#b6ffb6; --muted:#76c876; --accent:#00ff88; --danger:#ff5577; --ok:#44ff99; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text); padding:24px}
    body::before{content:""; position:fixed; inset:0; background-image: linear-gradient(var(--grid) 1px, transparent 1px), linear-gradient(90deg, var(--grid) 1px, transparent 1px); background-size:24px 24px, 24px 24px; opacity:.22; pointer-events:none}
    .wrap{max-width:1100px; margin:0 auto}
    h1{margin:0 0 8px}
    .sub{color:var(--muted); margin-bottom:18px}
    .tabs{display:flex; gap:10px; margin-bottom:16px}
    .tab{cursor:pointer; border:1px solid #0b2a0b; background:#041004; color:var(--text); padding:10px 14px; border-radius:12px; font-weight:700}
    .tab.active{border-color:var(--accent); box-shadow:0 0 0 1px rgba(0,255,136,.25) inset}
    .grid{display:grid; gap:16px; grid-template-columns:1.15fr 1fr}
    .card{background:linear-gradient(180deg, rgba(8,24,8,.9), rgba(8,24,8,.65)); border:1px solid #0b2a0b; border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{width:100%; border:1px solid #0b2a0b; border-radius:12px; background:#051105; color:var(--text); padding:10px; outline:none}
    textarea{min-height:160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .row{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    .btns{display:flex; gap:10px; margin-top:10px}
    button{cursor:pointer; border:1px solid #0b2a0b; background:#041004; color:var(--text); padding:10px 12px; border-radius:12px; font-weight:600}
    button.primary{border-color:var(--accent); box-shadow:0 0 0 1px rgba(0,255,136,.2) inset}
    .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .kpi{background:#051405; border:1px solid #0b2a0b; border-radius:14px; padding:14px}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:22px; font-weight:700; margin-top:6px}
    canvas{width:100%; height:240px; display:block; border-radius:12px; background:#041204; border:1px solid #0b2a0b}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 6px; border-bottom:1px dashed #0b2a0b; text-align:left}
    .muted{color:var(--muted)}
    .hidden{display:none}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .row{grid-template-columns:1fr} .kpis{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Alea Matrix</h1>
    <div class="sub">Single-page app with two modes: <b>Calculator</b> and <b>Ratios</b>. Click the tabs to switch views. Nothing here is advice.</div>

    <div class="tabs">
      <button class="tab active" data-tab="calc">Calculator</button>
      <button class="tab" data-tab="ratios">Ratios</button>
    </div>

    <!-- CALCULATOR VIEW -->
    <div id="view-calc">
      <div class="grid">
        <section class="card">
          <div class="row">
            <div>
              <label>Account Size</label>
              <input id="account" type="number" inputmode="decimal" value="25000" />
            </div>
            <div>
              <label>Risk per Trade (%)</label>
              <input id="riskPct" type="number" inputmode="decimal" value="1" />
            </div>
            <div>
              <label>Entry Price</label>
              <input id="entry" type="number" inputmode="decimal" value="100" />
            </div>
            <div>
              <label>Stop Price</label>
              <input id="stop" type="number" inputmode="decimal" value="95" />
            </div>
            <div>
              <label>Target Price</label>
              <input id="target" type="number" inputmode="decimal" value="110" />
            </div>
            <div>
              <label>Win Rate (0–1)</label>
              <input id="win" type="number" step="0.01" min="0" max="1" value="0.45" />
            </div>
            <div class="row" style="grid-column:1/-1; grid-template-columns:1fr">
              <div>
                <label>Tick/Contract Multiplier (optional)</label>
                <input id="mult" type="number" inputmode="decimal" value="1" />
              </div>
            </div>
          </div>
          <div class="btns">
            <button class="primary" id="calcBtn">Calculate</button>
            <button id="resetBtn">Reset</button>
          </div>
          <div class="muted" style="margin-top:8px">Formulas: pos = (account×risk%) / (|entry−stop|×mult). RR = |target−entry|/|entry−stop|. Kelly f = p − (1−p)/RR. Suggested ≈ ½·Kelly (cap 0–2%).</div>
        </section>
        <section class="card">
          <div class="kpis">
            <div class="kpi"><div class="label">Risk Amount</div><div class="value" id="riskAmt">—</div><small class="muted">Base currency</small></div>
            <div class="kpi"><div class="label">Position Size (units)</div><div class="value" id="pos">—</div><small class="muted">Shares / contracts</small></div>
            <div class="kpi"><div class="label">R:R</div><div class="value" id="rr">—</div><small class="muted">Reward : Risk</small></div>
          </div>
          <div class="kpis" style="margin-top:12px">
            <div class="kpi"><div class="label">Kelly Fraction</div><div class="value" id="kelly">—</div><small class="muted">Theoretical optimal f</small></div>
            <div class="kpi"><div class="label">Suggested Risk %</div><div class="value" id="sugRisk">—</div><small class="muted">½·Kelly (0–2% cap)</small></div>
            <div class="kpi"><div class="label">EV / trade</div><div class="value" id="ev">—</div><small class="muted">In R units</small></div>
          </div>
        </section>
      </div>

      <section class="card" style="margin-top:16px">
        <table style="width:100%; border-collapse:collapse">
          <thead><tr><th>Scenario</th><th>Metric</th><th>Value</th><th>Note</th></tr></thead>
          <tbody>
            <tr><td>Losing Streak (95% conf.)</td><td><span style="display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #0b2a0b;background:#071707">max consecutive losses</span></td><td id="ls">—</td><td class="muted">Plan sizing to survive this</td></tr>
            <tr><td>Drawdown Budget</td><td><span style="display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #0b2a0b;background:#071707">risk% × streak</span></td><td id="dd">—</td><td class="muted">Keep under psychological limit</td></tr>
            <tr><td>Stop Distance</td><td><span style="display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #0b2a0b;background:#071707">|entry−stop|</span></td><td id="dist">—</td><td class="muted">Price units</td></tr>
          </tbody>
        </table>
      </section>
    </div>

    <!-- RATIOS VIEW -->
    <div id="view-ratios" class="hidden">
      <div class="grid">
        <section class="card">
          <div class="row">
            <div>
              <label>Periodic Returns Input</label>
              <textarea id="returns" placeholder="One return per line, e.g.\n0.004\n-0.012\n0.006\n...">0.004\n-0.012\n0.006\n0.010\n-0.007\n0.003\n</textarea>
            </div>
            <div>
              <label>Upload CSV (optional)</label>
              <input id="file" type="file" accept=".csv,text/csv" />
              <div style="height:12px"></div>
              <label>Periodicity</label>
              <select id="period">
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
              <div style="height:12px"></div>
              <label>Risk-free Rate (annual, %)</label>
              <input id="rf" type="number" inputmode="decimal" value="0.0" />
              <div style="height:12px"></div>
              <label>Target/ MAR for Sortino (annual, %)</label>
              <input id="mar" type="number" inputmode="decimal" value="0.0" />
            </div>
          </div>
          <div class="btns">
            <button class="primary" id="ratioCalc">Calculate Ratios</button>
            <button id="ratioClear">Clear</button>
            <button id="ratioDemo">Demo Data</button>
          </div>
          <div class="muted" style="margin-top:8px">CSV accepted formats: single column of returns (fractional, e.g., 0.012) or two columns <code>date,return</code>.</div>
        </section>
        <section class="card">
          <div class="kpis">
            <div class="kpi"><div class="label">Sharpe (ann.)</div><div class="value" id="sharpe">—</div></div>
            <div class="kpi"><div class="label">Sortino (ann.)</div><div class="value" id="sortino">—</div></div>
            <div class="kpi"><div class="label">CAGR</div><div class="value" id="cagr">—</div></div>
          </div>
          <div class="kpis" style="margin-top:12px">
            <div class="kpi"><div class="label">Stdev (ann.)</div><div class="value" id="stdev">—</div></div>
            <div class="kpi"><div class="label">Downside Dev (ann.)</div><div class="value" id="downside">—</div></div>
            <div class="kpi"><div class="label">Max Drawdown</div><div class="value" id="mdd">—</div></div>
          </div>
        </section>
      </div>
      <section class="card" style="margin-top:16px">
        <canvas id="chart"></canvas>
        <div class="muted" style="margin-top:8px">Cumulative equity curve from provided returns (rebased to 1.0).</div>
      </section>
    </div>
  </div>

  <script>
    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const views = { calc: document.getElementById('view-calc'), ratios: document.getElementById('view-ratios') };
    tabs.forEach(btn=>btn.addEventListener('click', ()=>{
      tabs.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const key = btn.dataset.tab; Object.entries(views).forEach(([k,el])=> el.classList.toggle('hidden', k!==key));
      // Update hash for shareable deep link
      history.replaceState(null, '', '#' + key);
    }));
    // Deep linking by hash
    const start = (location.hash||'#calc').replace('#','');
    const initial = document.querySelector(`.tab[data-tab="${start}"]`); if(initial){ initial.click(); }

    // Helpers
    const $ = id => document.getElementById(id);
    const fmt = (n, d=2) => isFinite(n) ? Number(n).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d}) : '—';

    // CALCULATOR logic
    function calc(){
      const account = parseFloat($("account").value);
      const riskPct = parseFloat($("riskPct").value)/100;
      const entry = parseFloat($("entry").value);
      const stop = parseFloat($("stop").value);
      const target = parseFloat($("target").value);
      const p = Math.max(0, Math.min(1, parseFloat($("win").value)));
      const mult = Math.max(0.0000001, parseFloat($("mult").value)||1);

      const dist = Math.abs(entry - stop);
      const reward = Math.abs(target - entry);
      const rr = reward / (dist || 1e-9);

      const riskAmt = account * riskPct;
      const pos = riskAmt / (dist * mult || 1e-9);

      const kelly = p - (1 - p) / (rr || 1e-9);
      const kellyClamped = Math.max(-1, Math.min(1, kelly));
      const suggested = Math.max(0, Math.min(0.02, 0.5 * Math.max(0, kellyClamped)));

      const evR = p * rr - (1 - p);

      let losingStreak = '—';
      if(p<1){ losingStreak = Math.ceil(Math.log(0.05) / Math.log(1 - p)); }
      const dd = (losingStreak==='—' ? '—' : (losingStreak * riskPct * 100).toFixed(1) + '%');

      $("riskAmt").textContent = fmt(riskAmt, 2);
      $("pos").textContent = isFinite(pos) && pos>0 ? fmt(pos, 2) : '—';
      $("rr").textContent = isFinite(rr) ? fmt(rr, 2) : '—';
      $("kelly").innerHTML = (kellyClamped>=0?'<span style="color:var(--ok)">':'<span style="color:var(--danger)">') + fmt(kellyClamped, 2) + '</span>';
      $("sugRisk").textContent = (suggested*100).toFixed(2) + '%';
      $("ev").innerHTML = (evR>=0?'<span style="color:var(--ok)">':'<span style="color:var(--danger)">') + fmt(evR, 2) + '</span>';
      $("ls").textContent = losingStreak;
      $("dd").textContent = dd;
      $("dist").textContent = fmt(dist, 4);
    }
    $("calcBtn").addEventListener('click', calc);
    $("resetBtn").addEventListener('click', ()=>{
      ["account","riskPct","entry","stop","target","win","mult"].forEach(id=>$(id).value = $(id).getAttribute('value')||$(id).defaultValue||$(id).value);
      ["riskAmt","pos","rr","kelly","sugRisk","ev","ls","dd","dist"].forEach(id=>$(id).textContent = '—');
    });

    // RATIOS logic
    const ANNUALS = { daily: 252, weekly: 52, monthly: 12 };
    function parseText(txt){
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const vals = []; for(const line of lines){ const parts = line.split(/,|;|\s+/).map(s=>s.trim()).filter(Boolean); const v = parseFloat(parts[parts.length-1]); if(!isNaN(v)) vals.push(v); } return vals;
    }
    function mean(a){ return a.reduce((s,x)=>s+x,0)/a.length; }
    function stdev(a){ const m=mean(a); return Math.sqrt(a.reduce((s,x)=>s+(x-m)*(x-m),0)/(a.length-1)); }
    function downsideDev(a, mar){ const diff = a.map(x=>Math.min(0, x - mar)); const m = mean(diff); return Math.sqrt(diff.reduce((s,x)=>s+(x-m)*(x-m),0)/(diff.length-1)); }
    function equity(vals){ const e=[1]; for(const r of vals){ e.push(e[e.length-1]*(1+r)); } return e; }
    function maxDrawdown(eq){ let peak=eq[0], mdd=0; for(const v of eq){ peak = Math.max(peak, v); mdd = Math.min(mdd, v/peak - 1); } return mdd; }

    function drawChart(eq){ const c=$("chart"); const ctx=c.getContext('2d'); const w=c.width=c.clientWidth; const h=c.height=c.clientHeight; ctx.clearRect(0,0,w,h);
      const min=Math.min(...eq), max=Math.max(...eq); const pad=16; const xstep=(w-2*pad)/Math.max(1,eq.length-1); function y(v){ return h-pad - ( (v-min)/(max-min||1) )*(h-2*pad); }
      ctx.strokeStyle='rgba(0,255,120,0.2)'; ctx.lineWidth=1; ctx.beginPath(); for(let i=pad;i<w-pad;i+=Math.max(40,Math.floor(w/12))){ ctx.moveTo(i,pad); ctx.lineTo(i,h-pad);} for(let j=pad;j<h-pad;j+=40){ ctx.moveTo(pad,j); ctx.lineTo(w-pad,j);} ctx.stroke();
      ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle='rgba(0,255,136,0.8)'; eq.forEach((v,i)=>{ const X=pad+i*xstep, Y=y(v); if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y); }); ctx.stroke();
    }

    function ratiosCalc(){
      const period = $("period").value; const k = ANNUALS[period]||252;
      let vals = parseText($("returns").value);
      const rf_annual = parseFloat($("rf").value||0)/100; const mar_annual = parseFloat($("mar").value||0)/100;
      if(vals.length<2){ alert('Please provide at least 2 return values'); return; }
      const rf_p = Math.pow(1+rf_annual, 1/k) - 1; const mar_p = Math.pow(1+mar_annual, 1/k) - 1;
      const m = mean(vals); const sd = stdev(vals); const ddv = downsideDev(vals, mar_p);
      const sharpe = (m - rf_p) / (sd || 1e-12) * Math.sqrt(k);
      const sortino = (m - mar_p) / (ddv || 1e-12) * Math.sqrt(k);
      const eq = equity(vals); const mdd = maxDrawdown(eq);
      const total = eq[eq.length-1]; const years = vals.length / k; const cagr = Math.pow(total, 1/Math.max(1e-9, years)) - 1;
      $("sharpe").textContent = isFinite(sharpe)?sharpe.toFixed(2):'—';
      $("sortino").textContent = isFinite(sortino)?sortino.toFixed(2):'—';
      $("stdev").textContent = isFinite(sd)?(sd*Math.sqrt(k)).toFixed(2):'—';
      $("downside").textContent = isFinite(ddv)?(ddv*Math.sqrt(k)).toFixed(2):'—';
      $("mdd").textContent = isFinite(mdd)?(mdd*100).toFixed(2)+'%':'—';
      $("cagr").textContent = isFinite(cagr)?(cagr*100).toFixed(2)+'%':'—';
      drawChart(eq);
    }
    function ratiosClear(){ $("returns").value=''; $("rf").value='0.0'; $("mar").value='0.0'; ["sharpe","sortino","stdev","downside","mdd","cagr"].forEach(id=>$(id).textContent='—'); drawChart([1]); }
    function ratiosDemo(){ $("returns").value = [0.004,-0.012,0.006,0.010,-0.007,0.003,0.008,0.005,-0.009,0.012,0.004,-0.004,0.007,0.002,-0.006,0.009].join("\n"); }

    $("ratioCalc").addEventListener('click', ratiosCalc);
    $("ratioClear").addEventListener('click', ratiosClear);
    $("ratioDemo").addEventListener('click', ratiosDemo);

    // Defaults
    calc(); drawChart([1]);
  </script>
</body>
</html>
